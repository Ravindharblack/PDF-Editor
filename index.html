<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDF Editor ‚Äî Precise Text Editing</title>
  <style>
    /* Dark gradient + glass UI */
    body{margin:0;font-family:Inter,Arial;height:100vh;background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);color:#fff;display:flex;flex-direction:column}
    .glossy-header{background:linear-gradient(to right,rgba(255,255,255,0.06),rgba(255,255,255,0.03));padding:14px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:40;border-bottom:2px solid rgba(150,80,255,0.2)}
    h1{margin:0;font-size:18px}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600;background:linear-gradient(180deg,#6b4ef7,#3b2bd9);color:#fff;box-shadow:0 6px 18px rgba(60,35,150,0.35)}
    .ghost{background:rgba(255,255,255,0.06);color:#fff;border:1px solid rgba(255,255,255,0.08)}
    .hero{padding:28px;text-align:center;display:flex;align-items:center;justify-content:center;transition:opacity 0.3s}
    #drop-zone{width:90%;max-width:800px;margin:16px auto;padding:28px;text-align:center;border-radius:14px;border:2px dashed rgba(255,255,255,0.12);transition:0.25s}
    #drop-zone.dragover{background:rgba(255,255,255,0.03);border-color:#9b59ff;box-shadow:0 0 26px rgba(155,89,255,0.12);transform:translateY(-4px)}

    #pages{flex:1;overflow:auto;padding:20px;display:flex;flex-direction:column;align-items:center;gap:28px;transition:transform 0.3s ease-out;transform-origin:top center}
    .page-wrap{width:820px;background:rgba(255,255,255,0.03);backdrop-filter:blur(8px);padding:14px;border-radius:16px;border:2px solid rgba(120,80,255,0.14);box-shadow:0 10px 30px rgba(0,0,0,0.6);position:relative}
    canvas{width:100%;height:auto;border-radius:10px;display:block}
    
    /* Text layer and spans for editing */
    .text-layer{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
    .text-span{position:absolute;white-space:pre;font-family:inherit;pointer-events:auto;cursor:text;color:#fff}
    
    /* Floating toolbar & sidebar */
    .floating-toolbar{position:fixed;bottom:26px;right:26px;background:rgba(255,255,255,0.04);backdrop-filter:blur(8px);padding:10px;border-radius:12px;display:flex;gap:8px;z-index:60}
    .sidebar{position:fixed;left:12px;top:90px;width:56px;height:calc(100vh - 160px);background:rgba(255,255,255,0.03);backdrop-filter:blur(8px);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px;align-items:center;z-index:50}

    /* Editor input and highlights */
    .editor-input{position:absolute;z-index:2000;padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.12);background:rgba(0,0,0,0.8);color:#fff;font-family:inherit;box-shadow:0 4px 12px rgba(0,0,0,0.4)}
    
    /* Highlight/Edit indicator box */
    .highlight-box{position:absolute;pointer-events:none;border-radius:4px}
    .text-edit-box{background:rgba(255,255,255,0.9);z-index:100;opacity:1;} /* White-out box */
    .highlight-mode-box{background:rgba(255,235,59,0.24);z-index:110;}

    /* small helpers */
    #page-indicator{margin-left:8px;font-weight:600}
    .tool-btn{width:42px;height:42px;border-radius:10px;background:rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid rgba(255,255,255,0.06);user-select:none;opacity:0.6;transition:opacity 0.2s}
    .tool-btn:hover{opacity:1}
    .tool-btn.active{opacity:1;box-shadow:0 0 10px rgba(155,89,255,0.5)}
    .tool-btn:active{transform:scale(0.95)}
  </style>
</head>
<body>

<header class="glossy-header">
  <h1>PDF Editor ‚Äî Edit text & shapes directly</h1>
  <div style="flex:1"></div>
  <div class="controls">
    <input id="file" type="file" accept="application/pdf" style="display:none;" />
    <button id="upload-btn" class="btn ghost">Upload PDF</button>
    <button id="download" class="btn">Export PDF</button>
    <button id="save-local" class="btn ghost">Save</button>
  </div>
  <div id="page-indicator">No file</div>
</header>

<section class="hero">
  <div id="drop-zone">Drop a PDF here or click "Upload PDF" ‚Äî images, tables and layout are preserved. Click any visible text to edit.</div>
</section>

<main id="pages"></main>

<div class="floating-toolbar">
  <div id="undo" class="tool-btn" title="Undo">‚Ü∂</div>
  <div id="redo" class="tool-btn" title="Redo">‚Ü∑</div>
  <div id="zoom-in" class="tool-btn" title="Zoom in">Ôºã</div>
  <div id="zoom-out" class="tool-btn" title="Zoom out">‚àí</div>
  <div id="highlight-mode" class="tool-btn" title="Highlight">‚ú±</div>
  <div id="shape-mode" class="tool-btn" title="Add shape">‚ñ≠</div>
  <div id="sign-mode" class="tool-btn" title="Signature">‚úçÔ∏è</div>
</div>

<div class="sidebar">
  <div class="tool-btn" id="nav-prev" title="Previous Page">‚óÄ</div>
  <div class="tool-btn" id="nav-next" title="Next Page">‚ñ∂</div>
  <div class="tool-btn" id="search-open" title="Search">üîé</div>
</div>

<footer>PDF Editor ¬© 2025 ‚Äî Built for fast in-browser editing ‚Ä¢ Local autosave enabled</footer>

<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.6.172/build/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdn.jsdelivr.net/npm/pdfjs-dist@3.6.172/build/pdf.worker.min.js';

  // --- Configuration ---
  const TEXT_MERGE_TOLERANCE = 5; // Pixels distance for merging text fragments.

  // --- State ---
  let originalBytes = null;
  let pdf = null;
  let history = [];
  let historyPtr = -1;
  let currentPageIndex = 0;
  let zoomScale = 1.0;
  let pagesEls = [];
  const pagesContainer = document.getElementById('pages');
  const dropZone = document.getElementById('drop-zone');
  const hero = document.querySelector('.hero');
  const pageIndicator = document.getElementById('page-indicator');
  const uploadButton = document.getElementById('upload-btn');

  // --- Helpers ---
  function abToBase64(ab){ const bytes=new Uint8Array(ab); let binary=''; for(let i=0;i<bytes.length;i++) binary += String.fromCharCode(bytes[i]); return btoa(binary); }
  function base64ToAb(base64){ const binary=atob(base64); const len=binary.length; const bytes=new Uint8Array(len); for(let i=0;i<len;i++) bytes[i]=binary.charCodeAt(i); return bytes.buffer; }
  function dataURLToUint8Array(dataURL){ const b64 = dataURL.split(',')[1]; const bin = atob(b64); const len = bin.length; const arr = new Uint8Array(len); for(let i=0;i<len;i++) arr[i]=bin.charCodeAt(i); return arr; }
  
  // --- History & Local Storage ---
  function pushHistory(action){ history = history.slice(0, historyPtr+1); history.push(action); historyPtr++; updateUndoRedo(); saveLocal(); replayHistory(); }
  function updateUndoRedo(){ 
    document.getElementById('undo').style.opacity = historyPtr>=0?1:0.4; 
    document.getElementById('redo').style.opacity = historyPtr < history.length-1 ? 1 : 0.4; 
  }
  function saveLocal(){ try{ const obj={history:history, original: originalBytes?abToBase64(originalBytes):null}; localStorage.setItem('pdf_editor_v1', JSON.stringify(obj)); }catch(e){console.warn('local save failed',e);} }
  function loadLocal(){ try{ const s=localStorage.getItem('pdf_editor_v1'); if(!s) return; const obj=JSON.parse(s); if(obj.original){ originalBytes = base64ToAb(obj.original); loadPdf(originalBytes).then(()=>{ history = obj.history||[]; historyPtr = history.length-1; updateUndoRedo(); replayHistory(); }).catch(e=>console.error('PDF load failed', e)); } }catch(e){console.warn('local load failed',e);} }

  // --- File Upload & Rendering ---
  uploadButton.addEventListener('click', ()=>document.getElementById('file').click());
  document.getElementById('file').addEventListener('change', async e=>{ const f=e.target.files[0]; if(!f) return; originalBytes = await f.arrayBuffer(); loadPdf(originalBytes); pushHistory({type:'load', time:Date.now()}); });

  // Drag & drop zone
  dropZone.addEventListener('click', ()=>document.getElementById('file').click());
  dropZone.addEventListener('dragover', e=>{ e.preventDefault(); dropZone.classList.add('dragover'); });
  dropZone.addEventListener('dragleave', ()=>dropZone.classList.remove('dragover'));
  dropZone.addEventListener('drop', async e=>{ e.preventDefault(); dropZone.classList.remove('dragover'); const f=e.dataTransfer.files[0]; if(f && f.type==='application/pdf'){ const ab=await f.arrayBuffer(); originalBytes = ab; loadPdf(ab); pushHistory({type:'load', time:Date.now()}); } });

  // Load PDF and render pages
  async function loadPdf(arrayBuffer){ 
    pagesContainer.innerHTML=''; 
    pagesEls=[]; 
    hero.style.opacity = 0; 
    hero.style.height = 0; 
    pdf = await pdfjsLib.getDocument({data:arrayBuffer}).promise; 
    pageIndicator.textContent = `Pages: ${pdf.numPages}`;
    
    for(let i=1;i<=pdf.numPages;i++){ 
      const page = await pdf.getPage(i); 
      const scale = 1.6;
      const viewport = page.getViewport({scale}); 
      
      const wrap = document.createElement('div'); 
      wrap.className='page-wrap'; 
      wrap.dataset.page = i-1; 
      
      const container = document.createElement('div'); 
      container.style.position='relative'; 
      
      const canvas = document.createElement('canvas'); 
      canvas.width = viewport.width; 
      canvas.height = viewport.height; 
      canvas.style.width='100%'; 
      
      const ctx = canvas.getContext('2d'); 
      await page.render({canvasContext:ctx,viewport}).promise; 
      container.appendChild(canvas); 
      
      const highlightLayer = document.createElement('div'); 
      highlightLayer.className = 'highlight-layer';
      highlightLayer.style.position='absolute'; 
      highlightLayer.style.left='0'; 
      highlightLayer.style.top='0'; 
      highlightLayer.style.width='100%'; 
      highlightLayer.style.height='100%'; 
      highlightLayer.style.pointerEvents='none'; 
      container.appendChild(highlightLayer);
      
      const textLayer = document.createElement('div'); 
      textLayer.className='text-layer'; 
      container.appendChild(textLayer);
      
      wrap.appendChild(container); 
      pagesContainer.appendChild(wrap);

      // --- Text Aggregation and Rendering ---
      const textContent = await page.getTextContent();
      const items = textContent.items;
      const aggregatedItems = [];
      let currentBlock = null;

      for (let itemIndex = 0; itemIndex < items.length; itemIndex++) {
        const item = items[itemIndex];
        const tx = pdfjsLib.Util.transform(viewport.transform, item.transform);
        const x = tx[4];
        const y = tx[5];
        const width = item.width * scale;
        const height = item.height * scale;
        const fontSize = Math.hypot(tx[1], tx[3]) * scale;

        const currentItem = {
          str: item.str,
          x: x,
          y: y,
          w: width,
          h: height,
          fontSize: fontSize,
          transform: item.transform
        };

        if (currentBlock) {
          // Check for horizontal and vertical proximity
          const xDiff = currentItem.x - (currentBlock.x + currentBlock.w);
          const yDiff = Math.abs(currentItem.y - currentBlock.y);

          if (yDiff < currentBlock.h / 2 && xDiff < TEXT_MERGE_TOLERANCE) {
            // Merge the current item into the current block
            currentBlock.str += item.str;
            currentBlock.w = currentItem.x + currentItem.w - currentBlock.x; // Expand width
            currentBlock.h = Math.max(currentBlock.h, currentItem.h); // Maintain max height
          } else {
            // Start a new block
            aggregatedItems.push(currentBlock);
            currentBlock = currentItem;
          }
        } else {
          // Initialize the first block
          currentBlock = currentItem;
        }
      }
      if (currentBlock) {
        aggregatedItems.push(currentBlock);
      }

      // Render aggregated items as text spans
      aggregatedItems.forEach((block, blockIndex) => {
        const span = document.createElement('div'); 
        span.className='text-span'; 
        span.textContent = block.str.trim();
        
        // Critical for mapping edits!
        span.dataset.id = `${i-1}-${blockIndex}`; 
        span.dataset.originalText = block.str.trim();
        
        // Store coordinates and dimensions relative to PDF-Lib scale (1.0)
        span.dataset.x = block.x / scale;
        span.dataset.y = block.y / scale;
        span.dataset.w = block.w / scale;
        span.dataset.h = block.h / scale;
        span.dataset.fontSize = block.fontSize / scale;

        // Position relative to canvas pixel size (viewport size)
        span.style.left = (block.x/viewport.width*100)+'%'; 
        // Y coordinate needs inversion: (viewport.height - y_coord)
        span.style.top = ((viewport.height - block.y)/viewport.height*100)+'%'; 
        span.style.width = (block.w/viewport.width*100)+'%';
        span.style.height = (block.h/viewport.height*100)+'%';
        span.style.fontSize = (block.fontSize/viewport.height*100)+'%'; 
        span.style.pointerEvents='auto';
        span.style.transform = 'translateY(-100%)'; // Align baseline

        // click to edit
        span.addEventListener('click', (ev)=>{ 
          ev.stopPropagation(); 
          openTextEditor(span, i-1, block, canvas, viewport); 
        });
        textLayer.appendChild(span);
      });

      pagesEls.push({wrap,canvas,viewport,highlightLayer,textLayer,pageIndex:i-1});
    }
    // after render
    currentPageIndex = 0; scrollToPage(0); saveLocal();
  }

  function scrollToPage(idx){ 
    const el = pagesEls[idx]; 
    if(!el) return; 
    el.wrap.scrollIntoView({behavior:'smooth',block:'center'}); 
    pageIndicator.textContent = `Page ${idx+1} / ${pagesEls.length}`; 
    currentPageIndex = idx; 
  }

  // Page nav
  document.getElementById('nav-next').onclick = ()=>{ if(currentPageIndex < pagesEls.length-1) scrollToPage(currentPageIndex+1); };
  document.getElementById('nav-prev').onclick = ()=>{ if(currentPageIndex > 0) scrollToPage(currentPageIndex-1); };

  // --- Text Editing Logic ---
  async function openTextEditor(span,pageIndex,block,canvas,viewport){ 
    const rect = span.getBoundingClientRect(); 
    const input = document.createElement('input'); 
    input.className='editor-input'; 
    input.value = span.textContent; 
    document.body.appendChild(input); 
    
    // Position input over the span
    input.style.left = rect.left+'px'; 
    input.style.top = rect.top+'px'; 
    input.style.width = rect.width + 'px'; 
    input.style.height = rect.height + 'px';
    input.style.fontSize = window.getComputedStyle(span).fontSize;
    input.style.transform = 'translateY(0%)'; // Undo span baseline adjustment for input
    
    input.focus();
    
    input.onblur = ()=>{ 
      const newText = input.value.trim(); 
      document.body.removeChild(input); 
      
      if(newText === span.textContent) return; 
      
      // Update the span visually
      span.textContent = newText;
      span.dataset.editedText = newText;

      // Use the stored PDF-Lib coordinates (already scaled to 1.0)
      const pdfX = parseFloat(span.dataset.x);
      const pdfY = parseFloat(span.dataset.y);
      const pdfW = parseFloat(span.dataset.w);
      const pdfH = parseFloat(span.dataset.h);
      const pdfFontSize = parseFloat(span.dataset.fontSize);
      
      const action = {
        type:'text-edit',
        id: span.dataset.id, // Use the unique ID
        pageIndex,
        x: pdfX,
        y: pdfY,
        w: pdfW,
        h: pdfH,
        text: newText,
        fontSize: pdfFontSize
      }; 
      pushHistory(action); 
    };
    
    input.onkeydown = e=>{ 
      if(e.key==='Enter') input.blur(); 
      if(e.key==='Escape'){ document.body.removeChild(input); } 
    };
  }

  // --- Apply visual edits (Text, Highlight, Signature) ---
  function applyEditPreview(action){ 
    const target = pagesEls[action.pageIndex]; 
    if(!target) return;
    
    // Coordinates are stored at scale 1.0 (PDFLib coordinates)
    // Convert PDF coordinates (bottom-left origin) to screen percentage (top-left origin)
    const xPct = (action.x / target.canvas.width * 100 * target.viewport.scale) + '%';
    const wPct = (action.w / target.canvas.width * 100 * target.viewport.scale) + '%';
    const hPct = (action.h / target.canvas.height * 100 * target.viewport.scale) + '%';
    // Y must be inverted and adjusted for height: (H_Canvas - Y_PDF - H_Action) / H_Canvas * 100
    const yPct = ((target.canvas.height - (action.y * target.viewport.scale) - (action.h * target.viewport.scale)) / target.canvas.height * 100) + '%';
    

    if(action.type==='text-edit'){ 
      // 1. Draw a white box to hide the original canvas text (white-out)
      const box = document.createElement('div'); 
      box.className='highlight-box text-edit-box'; 
      box.style.left = xPct; 
      box.style.top = yPct; 
      box.style.width = wPct; 
      box.style.height = hPct; 
      box.dataset.id = action.id; // Map box to the span
      target.highlightLayer.appendChild(box);

      // 2. Find and update the text span overlay
      const span = target.textLayer.querySelector(`[data-id="${action.id}"]`);
      if(span) {
        span.textContent = action.text;
        span.classList.add('edited-text');
      }

    } else if(action.type==='highlight'){ 
      const box = document.createElement('div'); 
      box.className='highlight-box highlight-mode-box';
      box.style.left = xPct; 
      box.style.top = yPct; 
      box.style.width = wPct; 
      box.style.height = hPct; 
      target.highlightLayer.appendChild(box); 
      
    } else if(action.type==='signature'){ 
      const img = new Image(); 
      img.src = action.dataUrl; 
      img.style.position='absolute'; 
      img.style.left=xPct; 
      img.style.top=yPct; 
      img.style.width=wPct; 
      img.style.height=hPct; 
      target.highlightLayer.appendChild(img);
    }
  }

  // --- History Replay for Text Edits ---
  function replayHistory(){ 
    pagesEls.forEach(p=>{ 
      p.highlightLayer.innerHTML=''; 
      // Reset all spans to original content and style
      p.textLayer.querySelectorAll('.text-span').forEach(s=>{
         s.textContent = s.dataset.originalText;
         s.classList.remove('edited-text');
      });
    });

    // Reapply actions up to historyPtr
    for(let i=0;i<=historyPtr;i++){ 
      const a = history[i]; 
      applyEditPreview(a); 
    }
    saveLocal(); 
  }

  // Undo / Redo
  document.getElementById('undo').onclick = ()=>{ 
    if(historyPtr<0) return; 
    historyPtr--; 
    replayHistory(); 
    updateUndoRedo(); 
  };
  document.getElementById('redo').onclick = ()=>{ 
    if(historyPtr >= history.length-1) return; 
    historyPtr++; 
    replayHistory(); 
    updateUndoRedo(); 
  };


  // --- Highlight Mode ---
  let isHighlighting=false, hStart=null, currentHighlightBox=null;
  document.getElementById('highlight-mode').onclick = ()=>{ 
    isHighlighting = !isHighlighting; 
    document.getElementById('highlight-mode').classList.toggle('active', isHighlighting);
  };
  
  pagesContainer.addEventListener('pointerdown', e=>{ 
    if(!isHighlighting) return; 
    const pageWrap = e.target.closest('.page-wrap'); 
    if(!pageWrap) return; 
    const pageIndex = parseInt(pageWrap.dataset.page,10); 
    const pageObj = pagesEls[pageIndex]; 
    const canvasRect = pageObj.canvas.getBoundingClientRect(); 
    
    hStart = {pageIndex, x: e.clientX, y: e.clientY, canvasRect}; 
    
    // Create temporary visual highlight
    currentHighlightBox = document.createElement('div');
    currentHighlightBox.className = 'highlight-box highlight-mode-box';
    currentHighlightBox.style.background = 'rgba(155,89,255,0.4)';
    currentHighlightBox.style.position = 'absolute';
    currentHighlightBox.style.pointerEvents = 'none';
    pageObj.wrap.querySelector('div').appendChild(currentHighlightBox);
    
    e.preventDefault(); 
  });
  
  pagesContainer.addEventListener('pointermove', e=>{
    if(!isHighlighting || !hStart) return;
    
    const pageObj = pagesEls[hStart.pageIndex];
    const canvasRect = hStart.canvasRect;
    
    const x1 = Math.min(hStart.x, e.clientX), x2 = Math.max(hStart.x, e.clientX);
    const y1 = Math.min(hStart.y, e.clientY), y2 = Math.max(hStart.y, e.clientY);
    
    const left = x1 - canvasRect.left;
    const top = y1 - canvasRect.top;
    const width = x2 - x1;
    const height = y2 - y1;
    
    // Update temporary visual highlight box
    currentHighlightBox.style.left = (left / canvasRect.width * 100) + '%';
    currentHighlightBox.style.top = (top / canvasRect.height * 100) + '%';
    currentHighlightBox.style.width = (width / canvasRect.width * 100) + '%';
    currentHighlightBox.style.height = (height / canvasRect.height * 100) + '%';
  });

  pagesContainer.addEventListener('pointerup', e=>{ 
    if(!isHighlighting || !hStart || !currentHighlightBox) return; 
    
    const pageObj = pagesEls[hStart.pageIndex]; 
    const canvasRect = hStart.canvasRect; 
    
    const x1 = Math.min(hStart.x, e.clientX), x2 = Math.max(hStart.x, e.clientX); 
    const y1 = Math.min(hStart.y, e.clientY), y2 = Math.max(hStart.y, e.clientY); 
    
    const left = x1 - canvasRect.left; 
    const top = y1 - canvasRect.top; 
    const width = x2 - x1; 
    const height = y2 - y1; 
    
    // Remove the temporary box
    currentHighlightBox.remove();
    currentHighlightBox = null;

    if (width < 5 || height < 5) { // Prevent tiny clicks from being highlights
        hStart=null; return;
    }

    const xRatio = pageObj.canvas.width / canvasRect.width; 
    const yRatio = pageObj.canvas.height / canvasRect.height; 
    
    // PDF coordinates (bottom-left origin, scaled to 1.0)
    const pdfX = left * xRatio / pageObj.viewport.scale;
    const pdfW = width * xRatio / pageObj.viewport.scale;
    const pdfH = height * yRatio / pageObj.viewport.scale;
    // Y inversion: Canvas_Height - (Top_of_Highlight_from_Canvas + Height) * Y_Ratio
    const pdfY = (canvasRect.height - (top + height)) * yRatio / pageObj.viewport.scale;

    const action = {
        type:'highlight', 
        pageIndex:hStart.pageIndex, 
        x: pdfX, 
        y: pdfY, 
        w: pdfW, 
        h: pdfH
    }; 
    pushHistory(action); 
    hStart=null; 
  });
  
  // Prevent ghosting/lag when moving mouse off target
  pagesContainer.addEventListener('pointerleave', ()=>{
      if(hStart && currentHighlightBox) {
          currentHighlightBox.remove();
          currentHighlightBox = null;
          hStart = null;
      }
  });


  // --- Shapes & Signature (Simplified) ---
  document.getElementById('sign-mode').onclick = ()=>{ alert('Signature mode active. Click and drag on the page to draw a signature.'); startSignatureMode(); };
  async function startSignatureMode(){ 
    const pageObj = pagesEls[currentPageIndex]; 
    if(!pageObj) return; 
    
    const pageContainerDiv = pageObj.wrap.querySelector('div');
    const overlay = document.createElement('canvas'); 
    overlay.width = pageObj.canvas.width; 
    overlay.height = pageObj.canvas.height; 
    overlay.style.position='absolute'; 
    overlay.style.left='0'; 
    overlay.style.top='0'; 
    overlay.style.width='100%'; 
    overlay.style.height='100%'; 
    overlay.style.zIndex=120; 
    pageContainerDiv.appendChild(overlay); 
    
    const ctx = overlay.getContext('2d'); 
    ctx.strokeStyle='#f8f8f8'; // White signature
    ctx.lineWidth=4; 
    ctx.lineCap = 'round';
    
    let drawing=false; 
    
    overlay.addEventListener('pointerdown', e=>{ 
        drawing=true; 
        ctx.beginPath(); 
        const r=overlay.getBoundingClientRect(); 
        ctx.moveTo((e.clientX-r.left)/(r.width)*overlay.width, (e.clientY-r.top)/(r.height)*overlay.height); 
    }); 
    
    overlay.addEventListener('pointermove', e=>{ 
        if(!drawing) return; 
        const r=overlay.getBoundingClientRect(); 
        ctx.lineTo((e.clientX-r.left)/(r.width)*overlay.width, (e.clientY-r.top)/(r.height)*overlay.height); 
        ctx.stroke(); 
    }); 
    
    overlay.addEventListener('pointerup', async e=>{ 
        drawing=false; 
        
        const dataUrl = overlay.toDataURL('image/png'); 
        
        // Coordinates for PDF-Lib (full page)
        const action = {
            type:'signature', 
            pageIndex:currentPageIndex, 
            x:0, y:0, // Simplified: use full page coverage
            w:overlay.width / pageObj.viewport.scale, 
            h:overlay.height / pageObj.viewport.scale, 
            dataUrl
        }; 
        pushHistory(action); 
        
        overlay.remove();
        alert('Signature captured.');
    }); 
  }

  // --- Zoom buttons ---
  document.getElementById('zoom-in').onclick = ()=>{ 
    if (zoomScale < 1.8) zoomScale = Math.min(1.8, zoomScale + 0.2); 
    pagesContainer.style.transform = `scale(${zoomScale})`; 
  };
  document.getElementById('zoom-out').onclick = ()=>{ 
    if (zoomScale > 0.4) zoomScale = Math.max(0.4, zoomScale - 0.2); 
    pagesContainer.style.transform = `scale(${zoomScale})`; 
  };

  // --- Search (Keep it simple) ---
  let searchInput = null;
  document.getElementById('search-open').onclick = ()=>{
    document.getElementById('search-open').classList.toggle('active');
    if(searchInput){ searchInput.remove(); searchInput=null; document.querySelectorAll('.text-span').forEach(s=>{ s.style.background = 'transparent'; }); return; }
    searchInput = document.createElement('input'); 
    searchInput.placeholder='find...'; 
    searchInput.style.position='fixed'; 
    searchInput.style.top='120px'; 
    searchInput.style.left='18px'; 
    searchInput.style.padding='10px'; 
    searchInput.style.borderRadius='8px'; 
    searchInput.style.zIndex=90; 
    searchInput.style.border='none';
    document.body.appendChild(searchInput);
    
    searchInput.addEventListener('input', ()=>{ 
      const q=searchInput.value.toLowerCase(); 
      let firstFound = null;
      document.querySelectorAll('.text-span').forEach(s=>{ 
        if (q && s.textContent.toLowerCase().includes(q)) {
            s.style.background = 'rgba(255,235,59,0.3)';
            if (!firstFound) firstFound = s;
        } else {
            s.style.background = 'transparent';
        }
      });
      if(firstFound) firstFound.scrollIntoView({behavior:'smooth', block:'center'});
    });
    searchInput.focus();
  };


  // --- Export flattened PDF ---
  document.getElementById('download').addEventListener('click', async ()=>{
    if(!originalBytes) return alert('No PDF loaded');
    const pdfDoc = await PDFLib.PDFDocument.load(originalBytes);
    const helv = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
    const actionsToApply = history.slice(0, historyPtr+1);
    
    // Define colors for drawing
    const white = PDFLib.rgb(1,1,1);
    const black = PDFLib.rgb(0,0,0);
    const highlightColor = PDFLib.rgb(1,0.95,0.2); // Yellow

    for(const a of actionsToApply){ 
      try {
        const page = pdfDoc.getPages()[a.pageIndex]; 
        
        if(a.type==='text-edit'){ 
          // 1. Draw white rectangle (whiteout) over the old text area
          page.drawRectangle({ 
            x:a.x, 
            y:a.y, 
            width:a.w, 
            height:a.h, 
            color:white 
          }); 
          
          // 2. Draw the new text
          page.drawText(a.text, { 
            x:a.x, 
            y:a.y + (a.h * 0.1), // Adjusted Y to look centered
            size:a.fontSize, 
            font:helv, 
            color:black 
          }); 
          
        } else if(a.type==='highlight'){ 
          page.drawRectangle({ 
            x:a.x, 
            y:a.y, 
            width:a.w, 
            height:a.h, 
            color:highlightColor, 
            opacity:0.25 
          }); 
        } else if(a.type==='signature'){ 
          const pngBytes = dataURLToUint8Array(a.dataUrl); 
          const img = await pdfDoc.embedPng(pngBytes); 
          page.drawImage(img, { 
            x:a.x || 0, 
            y:a.y || 0, 
            width:a.w, 
            height:a.h 
          }); 
        }
      } catch (error) {
          console.error(`Error applying action ${a.type}:`, error);
      }
    }
    
    const out = await pdfDoc.save(); 
    const blob = new Blob([out],{type:'application/pdf'}); 
    const url = URL.createObjectURL(blob); 
    const downloadLink = document.createElement('a'); 
    downloadLink.href=url; 
    downloadLink.download='edited_flattened.pdf'; 
    downloadLink.click(); 
    URL.revokeObjectURL(url);
  });

  // Save button to explicitly save to localStorage
  document.getElementById('save-local').onclick = ()=>{ saveLocal(); alert('Saved locally'); };

  // init load local if present
  loadLocal();
</script>
</body>
</html>
